<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AIæ¼«å‰§å¯¼æ¼”å…¨èƒ½åŠ©æ‰‹ - æ•´åˆå¢å¼ºç‰ˆ</title>
    <style>
        :root { --primary: #6366f1; --success: #4ade80; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --border: #333; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; padding: 20px; background: var(--bg); color: var(--text); line-height: 1.6; margin: 0; }
        .container { max-width: 1000px; margin: 20px auto; background: var(--card); padding: 30px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* å¯¼èˆª Tab */
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .tab-btn { background: none; border: none; color: #888; padding: 10px 20px; cursor: pointer; font-weight: bold; font-size: 16px; border-radius: 8px; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        h2 { margin-top: 0; color: #a5b4fc; text-align: center; letter-spacing: 1px; }
        .input-group { margin-bottom: 25px; background: #252525; padding: 15px; border-radius: 10px; border: 1px solid #333; }
        label { display: block; margin-bottom: 8px; font-size: 13px; color: #aaa; text-transform: uppercase; font-weight: bold; }
        input[type="text"] { background: #1a1a1a; border: 1px solid #444; color: #fff; padding: 14px; width: 100%; border-radius: 8px; box-sizing: border-box; font-size: 16px; outline: none; transition: 0.3s; }
        input[type="text"]:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }

        .drop-area { border: 2px dashed #444; padding: 40px; text-align: center; border-radius: 12px; background: #1a1a1a; cursor: pointer; margin-bottom: 25px; transition: 0.3s; }
        .drop-area:hover { border-color: var(--primary); background: #222; }
        .drop-area p { margin: 0; color: #888; }

        .file-list-container { background: #141414; border-radius: 10px; border: 1px solid var(--border); max-height: 450px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #252525; padding: 15px 12px; text-align: left; color: #888; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid #222; vertical-align: middle; }
        
        .edit-input { background: #000; border: 1px solid #444; color: var(--success); padding: 8px 12px; width: 95%; border-radius: 6px; outline: none; font-family: monospace; }
        
        .action-bar { display: flex; gap: 15px; margin-top: 25px; }
        .main-btn { padding: 16px; border-radius: 8px; cursor: pointer; font-weight: bold; border: none; flex: 1; font-size: 16px; transition: 0.3s; }
        .btn-exec { background: var(--primary); color: white; }
        .btn-exec:disabled { opacity: 0.2; cursor: not-allowed; }
        .btn-clear { background: transparent; border: 1px solid #444; color: #ccc; }

        .op-btn { cursor: pointer; border: none; background: none; font-size: 12px; font-weight: bold; margin: 0 5px; transition: 0.2s; padding: 5px 8px; border-radius: 4px; }
        .modify-btn { color: var(--success); background: rgba(74, 222, 128, 0.1); }
        .del-btn { color: #f87171; background: rgba(248, 113, 113, 0.1); }

        #log { margin-top: 20px; text-align: center; color: #666; font-size: 14px; min-height: 24px; }
        .status-done { color: #555; font-style: italic; text-decoration: line-through; }
        footer { text-align: center; margin-top: 30px; font-size: 11px; color: #444; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('renameTab', this)">ğŸ¬ ç´ æé‡å‘½å</button>
        <button class="tab-btn" onclick="switchTab('mergeTab', this)">ğŸ“„ å‰§æœ¬ TXT åˆå¹¶</button>
    </div>

    <div id="renameTab" class="tab-content active">
        <h2>è§†é¢‘é‡å‘½å <small style="font-size: 12px; opacity: 0.5;">å·²é€‚é…æ—¥æœŸå‰”é™¤</small></h2>
        <div class="input-group">
            <label>ç»Ÿä¸€å‰§åå‰ç¼€ï¼ˆè‡ªåŠ¨ä¿å­˜ï¼‰</label>
            <input type="text" id="globalTitle" placeholder="è¾“å…¥æ–°å‰§å..." oninput="saveAndRefresh()">
        </div>
        <div id="dropZone" class="drop-area" onclick="selectRenameFolder()">
            <p>ğŸ“‚ æ‹–æ‹½æ–‡ä»¶å¤¹æˆ–è§†é¢‘åˆ°è¿™é‡Œï¼Œæˆ–ç‚¹å‡»é€‰æ‹©</p>
            <p style="font-size: 11px; margin-top: 8px; color: #eab308;">è‡ªåŠ¨è¯†åˆ«å¹¶å‰”é™¤ 2026XXXX ç­‰æ—¥æœŸæ—¶é—´æˆ³</p>
        </div>
        <div class="file-list-container">
            <table>
                <thead>
                    <tr><th width="35%">åŸæ–‡ä»¶å</th><th width="45%">é¢„è§ˆ</th><th width="20%" style="text-align:center">æ“ä½œ</th></tr>
                </thead>
                <tbody id="fileList"></tbody>
            </table>
        </div>
        <div class="action-bar">
            <button class="main-btn btn-clear" onclick="clearRenameList()">æ¸…ç©ºåˆ—è¡¨</button>
            <button class="main-btn btn-exec" id="execBtn" onclick="runBatchRename()" disabled>ç¡®è®¤æ‰¹é‡ä¿®æ”¹</button>
        </div>
    </div>

    <div id="mergeTab" class="tab-content">
        <h2>å‰§æœ¬ç« èŠ‚åˆå¹¶</h2>
        <div class="drop-area" onclick="selectMergeFolder()">
            <p id="txtStatusText" style="color: var(--primary); font-weight: bold; font-size: 18px;">ğŸ“„ ç‚¹å‡»é€‰æ‹©å‰§æœ¬æ–‡ä»¶å¤¹</p>
            <p style="font-size: 11px; margin-top: 8px; color: #888;">æ”¯æŒ .txt å’Œ .md æ ¼å¼ï¼Œè‡ªåŠ¨æŒ‰é›†æ•°è‡ªç„¶æ’åº</p>
        </div>
        <div id="txtPreview" style="margin: 20px 0; text-align: center; color: var(--success); font-size: 14px;"></div>
        <div class="action-bar">
            <button class="main-btn btn-exec" id="mergeBtn" onclick="executeMerge()" disabled>åˆå¹¶å¹¶ä¿å­˜ä¸ºå®Œæ•´ TXT</button>
        </div>
    </div>

    <div id="log">ç³»ç»Ÿå°±ç»ª</div>
</div>

<footer>DIRECTOR TOOLKIT &copy; 2026 v2.0</footer>

<script>
    // --- å…¬ç”¨åˆ‡æ¢é€»è¾‘ ---
    function switchTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        btn.classList.add('active');
        document.getElementById('log').innerText = "å°±ç»ª";
    }

    // --- è§†é¢‘é‡å‘½åæ ¸å¿ƒé€»è¾‘ ---
    let renameFiles = [];
    window.onload = () => {
        const saved = localStorage.getItem('lastSeriesTitle');
        if (saved) document.getElementById('globalTitle').value = saved;
    };

    function saveAndRefresh() {
        localStorage.setItem('lastSeriesTitle', document.getElementById('globalTitle').value);
        refreshRenameUI();
    }

    function getSmartRename(oldName) {
        const prefix = document.getElementById('globalTitle').value.trim();
        let clean = oldName.replace(/\d{8}(_\d{6})?/, '').replace(/_final_video/gi, '').replace(/\.(mp4|mov|mkv|webm)$/gi, '').trim();
        
        const regexA = /^(.*?)-ç¬¬([\dä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)é›†\s+(.*)/;
        const matchA = clean.match(regexA);
        if (matchA) return `${prefix || matchA[1]} ç¬¬${matchA[2]}é›† ${matchA[3].trim()}.mp4`;

        const regexB = /ç¬¬([\dä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]{1,4})[é›†è¯]/;
        const matchB = clean.match(regexB);
        if (matchB) return `${prefix || clean.split(regexB)[0].replace(/[-_]$/, '').trim() || 'ç´ æ'} ç¬¬${matchB[1]}é›†.mp4`;

        const matchC = clean.match(/(\d{1,4})/);
        if (matchC) return `${prefix || 'ç´ æ'} ç¬¬${matchC[1].replace(/^0+/, '') || "0"}é›†.mp4`;

        return `${prefix || 'ç´ æ'}_${clean}.mp4`;
    }

    async function selectRenameFolder() {
        try {
            const d = await window.showDirectoryPicker();
            renameFiles = [];
            for await (const e of d.values()) {
                if (e.kind === 'file' && /\.(mp4|mov|mkv|webm)$/i.test(e.name)) {
                    renameFiles.push({ handle: e, oldName: e.name, newName: getSmartRename(e.name), isDone: false });
                }
            }
            refreshRenameUI();
        } catch(e) {}
    }

    function refreshRenameUI() {
        const tbody = document.getElementById('fileList');
        renameFiles.forEach(f => { if(!f.isDone) f.newName = getSmartRename(f.oldName); });
        tbody.innerHTML = renameFiles.map((item, index) => `
            <tr>
                <td style="color:#666; font-size:11px;">${item.oldName}</td>
                <td><input type="text" class="edit-input" value="${item.newName}" oninput="renameFiles[${index}].newName=this.value"></td>
                <td style="text-align:center">
                    <button class="op-btn del-btn" onclick="renameFiles.splice(${index},1);refreshRenameUI()">ç§»é™¤</button>
                </td>
            </tr>
        `).join('');
        document.getElementById('execBtn').disabled = !renameFiles.length;
    }

    async function runBatchRename() {
        for (let item of renameFiles) {
            try {
                if (await item.handle.queryPermission({mode: 'readwrite'}) !== 'granted') await item.handle.requestPermission({mode: 'readwrite'});
                await item.handle.move(item.newName);
            } catch (e) {}
        }
        alert("æ‰¹é‡é‡å‘½åå®Œæˆï¼");
        renameFiles = []; refreshRenameUI();
    }
    function clearRenameList() { renameFiles = []; refreshRenameUI(); }

    // --- å‰§æœ¬åˆå¹¶é€»è¾‘ ---
    let mergeHandles = [];
    let scriptTitle = "åˆå¹¶å‰§æœ¬";

    async function selectMergeFolder() {
        try {
            const d = await window.showDirectoryPicker();
            mergeHandles = [];
            for await (const e of d.values()) {
                if (e.kind === 'file' && /\.(txt|md)$/i.test(e.name)) mergeHandles.push(e);
            }
            if (mergeHandles.length > 0) {
                mergeHandles.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true}));
                let first = mergeHandles[0].name;
                scriptTitle = first.replace(/\.(txt|md)$/i, '').replace(/ç¬¬\s*\d+\s*[é›†|è¯|ç« |å›]/, '').replace(/^[_\-\s]+|[_\-\s]+$/g, '');
                document.getElementById('txtPreview').innerHTML = `âœ… è¯†åˆ«å‰§åï¼š<strong>ã€Š${scriptTitle || 'æœªå‘½å'}ã€‹</strong>ï¼Œå…± ${mergeHandles.length} ç« `;
                document.getElementById('mergeBtn').disabled = false;
            }
        } catch(e) {}
    }

    async function executeMerge() {
        let fullText = "";
        for (const handle of mergeHandles) {
            const file = await handle.getFile();
            const text = await file.text();
            fullText += `\r\n\r\n===== ${handle.name.replace(/\.(txt|md)$/i, '')} =====\r\n\r\n${text}\r\n\r\n`;
        }
        const blob = new Blob([fullText], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${scriptTitle || 'å…¨é›†åˆå¹¶'}_å…¨é›†åˆå¹¶.txt`;
        a.click();
        URL.revokeObjectURL(url);
        document.getElementById('log').innerText = "å‰§æœ¬å¯¼å‡ºæˆåŠŸï¼";
    }

    // --- æ‹–æ‹½æ”¯æŒ (è§†é¢‘é‡å‘½å) ---
    const dropZone = document.getElementById('dropZone');
    dropZone.ondragover = e => e.preventDefault();
    dropZone.ondrop = async e => {
        e.preventDefault();
        const items = [...e.dataTransfer.items];
        for (const item of items) {
            const h = await item.getAsFileSystemHandle();
            if (h.kind === 'directory') { for await (const entry of h.values()) if(/\.(mp4|mov|mkv|webm)$/i.test(entry.name)) renameFiles.push({ handle: entry, oldName: entry.name, newName: getSmartRename(entry.name), isDone: false }); }
            else if(/\.(mp4|mov|mkv|webm)$/i.test(h.name)) renameFiles.push({ handle: h, oldName: h.name, newName: getSmartRename(h.name), isDone: false });
        }
        refreshRenameUI();
    };
</script>
</body>
</html>

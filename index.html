<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ¼«å‰§å¯¼æ¼”åŠ©æ‰‹ - å…¨æ ¼å¼é€‚é…ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>
        :root { --primary: #6366f1; --success: #4ade80; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --border: #333; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; padding: 20px; background: var(--bg); color: var(--text); line-height: 1.6; margin: 0; }
        .container { max-width: 1000px; margin: 20px auto; background: var(--card); padding: 30px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .tab-btn { background: none; border: none; color: #888; padding: 10px 20px; cursor: pointer; font-weight: bold; font-size: 16px; border-radius: 8px; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        h2 { margin-top: 0; color: #a5b4fc; text-align: center; }
        .input-group { margin-bottom: 25px; background: #252525; padding: 15px; border-radius: 10px; border: 1px solid #333; }
        label { display: block; margin-bottom: 8px; font-size: 13px; color: #aaa; font-weight: bold; }
        input[type="text"] { background: #1a1a1a; border: 1px solid #444; color: #fff; padding: 14px; width: 100%; border-radius: 8px; box-sizing: border-box; font-size: 16px; outline: none; }

        .drop-area { border: 2px dashed #444; padding: 40px; text-align: center; border-radius: 12px; background: #1a1a1a; cursor: pointer; transition: 0.3s; }
        .drop-area:hover { border-color: var(--primary); background: #222; }
        .btn-group { display: flex; gap: 15px; justify-content: center; margin-top: 15px; }
        .sub-btn { background: #333; color: #ccc; border: 1px solid #444; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; }

        .file-list-container { background: #141414; border-radius: 10px; border: 1px solid var(--border); max-height: 450px; overflow-y: auto; margin-top: 25px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #252525; padding: 15px 12px; text-align: left; color: #888; position: sticky; top: 0; border-bottom: 2px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid #222; }
        .edit-input { background: #000; border: 1px solid #444; color: var(--success); padding: 8px 12px; width: 95%; border-radius: 6px; outline: none; }
        
        .action-bar { display: flex; gap: 15px; margin-top: 25px; }
        .main-btn { padding: 16px; border-radius: 8px; cursor: pointer; font-weight: bold; border: none; flex: 1; font-size: 16px; transition: 0.3s; }
        .btn-exec { background: var(--primary); color: white; }
        .btn-exec:disabled { opacity: 0.2; cursor: not-allowed; }
        .btn-clear { background: transparent; border: 1px solid #444; color: #ccc; }

        #log { margin-top: 20px; text-align: center; color: #94a3b8; font-size: 14px; }
        footer { text-align: center; margin-top: 30px; font-size: 11px; color: #444; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('renameTab', this)">ğŸ¬ è§†é¢‘ç´ æå‘½å</button>
        <button class="tab-btn" onclick="switchTab('mergeTab', this)">ğŸ“„ å‰§æœ¬å…¨é›†åˆå¹¶</button>
    </div>

    <div id="renameTab" class="tab-content active">
        <h2>è§†é¢‘å‘½åå·¥ä½œç«™</h2>
        <div class="input-group">
            <label>æ–°å‰§åå‰ç¼€</label>
            <input type="text" id="globalTitle" placeholder="è¾“å…¥æ–°å‰§å..." oninput="saveAndRefresh()">
        </div>
        
        <div id="dropZone" class="drop-area">
            <h3>ğŸ“‚ å¯¼å…¥è§†é¢‘ç´ æ</h3>
            <p>æ”¯æŒæ‹–æ‹½æ•´ä¸ªæ–‡ä»¶å¤¹æˆ–å¤šä¸ªè§†é¢‘æ–‡ä»¶</p>
            <div class="btn-group">
                <button class="sub-btn" onclick="triggerSelect('directory')">é€‰æ‹©æ–‡ä»¶å¤¹</button>
                <button class="sub-btn" onclick="triggerSelect('files')">é€‰æ‹©æ–‡ä»¶</button>
            </div>
        </div>

        <div class="file-list-container">
            <table>
                <thead>
                    <tr><th width="35%">åŸæ–‡ä»¶å</th><th width="45%">é¢„è§ˆ</th><th width="20%" style="text-align:center">æ“ä½œ</th></tr>
                </thead>
                <tbody id="fileList"></tbody>
            </table>
        </div>
        <div class="action-bar">
            <button class="main-btn btn-clear" onclick="clearRenameList()">æ¸…ç©º</button>
            <button class="main-btn btn-exec" id="execBtn" onclick="runBatchRename()" disabled>ç¡®è®¤æ‰¹é‡é‡å‘½å</button>
        </div>
    </div>

    <div id="mergeTab" class="tab-content">
        <h2>å‰§æœ¬ TXT åˆå¹¶</h2>
        <div class="drop-area" onclick="triggerSelect('merge')">
            <p style="color: var(--primary); font-weight: bold; font-size: 18px;">ğŸ“„ ç‚¹å‡»é€‰æ‹©å‰§æœ¬æ–‡ä»¶å¤¹</p>
            <p>æ”¯æŒä¸Šä¼  .md, .txt, .docx (docéœ€å¦å­˜ä¸ºdocx)</p>
        </div>
        <div id="txtPreview" style="margin: 20px 0; text-align: center; color: var(--success); font-size: 14px;"></div>
        <div class="action-bar">
            <button class="main-btn btn-exec" id="mergeBtn" onclick="executeMerge()" disabled>åˆå¹¶å¹¶å¯¼å‡ºå…¨é›† TXT</button>
        </div>
    </div>
    <div id="log">å°±ç»ª</div>
</div>

<footer>DIRECTOR TOOLKIT &copy; 2026</footer>

<script>
    function switchTab(t, b) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(bn => bn.classList.remove('active'));
        document.getElementById(t).classList.add('active'); b.classList.add('active');
    }

    // ä¸­æ–‡æ•°å­—è½¬æ¢
    function chineseToNum(s) {
        if (!s) return 1;
        const map = {'é›¶':0,'ä¸€':1,'äºŒ':2,'ä¸¤':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'ä¸ƒ':7,'å…«':8,'ä¹':9,'å':10};
        if (s.length === 1) return map[s] ?? (parseInt(s) || 1);
        if (s.length === 2 && s[0] === 'å') return 10 + (map[s[1]] || 0);
        if (s.length === 2 && s[1] === 'å') return (map[s[0]] || 1) * 10;
        if (s.length === 3) return (map[s[0]] || 1) * 10 + (map[s[2]] || 0);
        return parseInt(s) || 1;
    }

    function getSmartRename(oldName) {
        const prefix = document.getElementById('globalTitle').value.trim();
        const ext = oldName.includes('.') ? oldName.split('.').pop() : 'mp4';
        const anchorRegex = /ç¬¬(.+?)[é›†è¯]/;
        const match = oldName.match(anchorRegex);
        let numResult = "1";

        if (match) {
            const content = match[1].trim();
            if (/^\d+$/.test(content)) numResult = parseInt(content, 10);
            else if (/[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]/.test(content)) numResult = chineseToNum(content);
        } else {
            const backup = oldName.replace(/\d{8}(_\d{6})?/, '').match(/(\d{1,3})/);
            numResult = backup ? backup[1].replace(/^0+/, '') : "1";
        }
        return `${prefix || ''} ç¬¬${numResult}é›†.${ext}`;
    }

    let renameFiles = [];
    async function triggerSelect(type) {
        try {
            if (type === 'directory') {
                const d = await window.showDirectoryPicker();
                for await (const e of d.values()) await addToFileList(e);
            } else if (type === 'files') {
                const handles = await window.showOpenFilePicker({ multiple: true });
                for (const h of handles) await addToFileList(h);
            } else if (type === 'merge') {
                await selectMergeFolder();
            }
            renderRenameUI();
        } catch (err) {}
    }

    async function addToFileList(handle) {
        if (handle.kind !== 'file' || !/\.(mp4|mov|mkv|webm)$/i.test(handle.name)) return;
        if (renameFiles.some(f => f.oldName === handle.name)) return;
        renameFiles.push({ handle, oldName: handle.name, newName: getSmartRename(handle.name), isDone: false });
    }

    function renderRenameUI() {
        const tbody = document.getElementById('fileList');
        tbody.innerHTML = renameFiles.map((item, i) => `
            <tr>
                <td style="color:#666; font-size:11px;">${item.oldName}</td>
                <td><input type="text" class="edit-input" value="${item.newName}" oninput="renameFiles[${i}].newName=this.value"></td>
                <td style="text-align:center"><button style="color:#f87171; border:none; background:none; cursor:pointer;" onclick="renameFiles.splice(${i},1);renderRenameUI()">ç§»é™¤</button></td>
            </tr>
        `).join('');
        document.getElementById('execBtn').disabled = !renameFiles.length;
    }

    async function runBatchRename() {
        for (let f of renameFiles) {
            try {
                if (await f.handle.queryPermission({mode:'readwrite'}) !== 'granted') await f.handle.requestPermission({mode:'readwrite'});
                await f.handle.move(f.newName);
            } catch (e) {}
        }
        alert("æ‰¹é‡ä¿®æ”¹å®Œæˆï¼"); renameFiles = []; renderRenameUI();
    }

    function saveAndRefresh() {
        localStorage.setItem('lastSeriesTitle', document.getElementById('globalTitle').value);
        renameFiles.forEach(f => { if(!f.isDone) f.newName = getSmartRename(f.oldName); });
        renderRenameUI();
    }

    window.onload = () => {
        const saved = localStorage.getItem('lastSeriesTitle');
        if (saved) document.getElementById('globalTitle').value = saved;
    };

    // --- å‰§æœ¬åˆå¹¶æ ¸å¿ƒé€»è¾‘ ---
    let mergeHandles = [];
    async function selectMergeFolder() {
        try {
            const d = await window.showDirectoryPicker();
            mergeHandles = [];
            for await (const e of d.values()) {
                if (e.kind === 'file' && /\.(txt|md|docx)$/i.test(e.name)) mergeHandles.push(e);
            }
            if (mergeHandles.length > 0) {
                mergeHandles.sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric:true}));
                document.getElementById('txtPreview').innerHTML = `âœ… å·²è¯†åˆ«ï¼š${mergeHandles.length} ä¸ªå‰§æœ¬æ–‡ä»¶`;
                document.getElementById('mergeBtn').disabled = false;
            }
        } catch(e) {}
    }

    async function executeMerge() {
        document.getElementById('log').innerText = "æ­£åœ¨æ·±åº¦è§£æå¹¶åˆå¹¶...";
        let fullContent = "";
        
        for (const h of mergeHandles) {
            const file = await h.getFile();
            let text = "";
            
            // å¤„ç†ä¸åŒçš„æ–‡ä»¶æ ¼å¼
            if (h.name.toLowerCase().endsWith('.docx')) {
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                text = result.value;
            } else {
                text = await file.text();
            }

            fullContent += `\r\n\r\n===== ${h.name.replace(/\.[^/.]+$/, "")} =====\r\n\r\n${text}\r\n\r\n`;
        }

        const blob = new Blob([fullContent], {type:'text/plain;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "åˆå¹¶å®Œæˆ_å‰§æœ¬åˆé›†.txt";
        a.click();
        document.getElementById('log').innerText = "å®Œæˆï¼å…¨é›†å·²å¯¼å‡ºä¸º TXTã€‚";
    }

    function clearRenameList() { renameFiles = []; renderRenameUI(); }
</script>
</body>
</html>

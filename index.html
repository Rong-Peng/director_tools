<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AIæ¼«å‰§ç´ æå‘½åå·¥å…· - å¯¼æ¼”çº é”™å¢å¼ºç‰ˆ</title>
    <style>
        :root { --primary: #6366f1; --success: #4ade80; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --border: #333; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; padding: 20px; background: var(--bg); color: var(--text); line-height: 1.6; }
        .container { max-width: 1000px; margin: auto; background: var(--card); padding: 30px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        h2 { margin-top: 0; color: #a5b4fc; text-align: center; letter-spacing: 1px; }
        .input-group { margin-bottom: 25px; background: #252525; padding: 15px; border-radius: 10px; border: 1px solid #333; }
        label { display: block; margin-bottom: 8px; font-size: 13px; color: #aaa; text-transform: uppercase; font-weight: bold; }
        input#globalTitle { background: #1a1a1a; border: 1px solid #444; color: #fff; padding: 14px; width: 100%; border-radius: 8px; box-sizing: border-box; font-size: 16px; outline: none; transition: 0.3s; }
        input#globalTitle:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }

        .drop-area { border: 2px dashed #444; padding: 40px; text-align: center; border-radius: 12px; background: #1a1a1a; cursor: pointer; margin-bottom: 25px; transition: 0.3s; }
        .drop-area:hover { border-color: var(--primary); background: #222; }
        .drop-area p { margin: 0; color: #888; }

        .file-list-container { background: #141414; border-radius: 10px; border: 1px solid var(--border); max-height: 500px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #252525; padding: 15px 12px; text-align: left; color: #888; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid #222; vertical-align: middle; }
        
        .edit-input { background: #000; border: 1px solid #444; color: var(--success); padding: 8px 12px; width: 95%; border-radius: 6px; outline: none; font-family: monospace; }
        .edit-input:focus { border-color: var(--success); }
        
        .op-btn { cursor: pointer; border: none; background: none; font-size: 12px; font-weight: bold; margin: 0 5px; transition: 0.2s; padding: 5px 8px; border-radius: 4px; }
        .modify-btn { color: var(--success); background: rgba(74, 222, 128, 0.1); }
        .modify-btn:hover { background: rgba(74, 222, 128, 0.2); }
        .del-btn { color: #f87171; background: rgba(248, 113, 113, 0.1); }
        .del-btn:hover { background: rgba(248, 113, 113, 0.2); }

        .action-bar { display: flex; gap: 15px; margin-top: 25px; }
        .main-btn { padding: 16px; border-radius: 8px; cursor: pointer; font-weight: bold; border: none; flex: 1; font-size: 16px; transition: 0.3s; }
        .btn-exec { background: var(--primary); color: white; }
        .btn-exec:hover { background: #4f46e5; }
        .btn-exec:disabled { opacity: 0.2; cursor: not-allowed; }
        .btn-clear { background: transparent; border: 1px solid #444; color: #ccc; }

        #log { margin-top: 20px; text-align: center; color: #666; font-size: 14px; min-height: 24px; }
        .status-done { color: #555; font-style: italic; text-decoration: line-through; }
    </style>
</head>
<body>

<div class="container">
    <h2>AI æ¼«å‰§ç´ æå‘½åå·¥å…· <small style="font-size: 12px; vertical-align: middle; opacity: 0.5;">v2026.3 ä¿®æ­£ç‰ˆ</small></h2>
    
    <div class="input-group">
        <label>ç»Ÿä¸€å‰§åå‰ç¼€ï¼ˆè‡ªåŠ¨ä¿å­˜ä¸Šæ¬¡è¾“å…¥ï¼‰</label>
        <input type="text" id="globalTitle" placeholder="è¾“å…¥æ–°å‰§åï¼Œå¦‚ï¼šè¢«æ¶æ¯’é‚»å±…å®³æ­»å" oninput="saveAndRefresh()">
    </div>

    <div id="dropZone" class="drop-area" onclick="selectFolder()">
        <p>ğŸ“‚ æ‹–æ‹½æ–‡ä»¶å¤¹æˆ–è§†é¢‘åˆ°è¿™é‡Œ</p>
        <p style="font-size: 11px; margin-top: 8px; color: #eab308;">ã€å·²ä¿®æ­£ã€‘è‡ªåŠ¨è¯†åˆ«å¹¶å‰”é™¤ 2026XXXX ç­‰æ—¥æœŸæ—¶é—´æˆ³</p>
    </div>

    <div class="file-list-container">
        <table>
            <thead>
                <tr>
                    <th width="35%">åŸå§‹æ–‡ä»¶å</th>
                    <th width="45%">é¢„è§ˆï¼ˆå·²è‡ªåŠ¨è¿‡æ»¤æ—¶é—´æˆ³ï¼‰</th>
                    <th width="20%" style="text-align: center;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="fileList"></tbody>
        </table>
    </div>

    <div class="action-bar">
        <button class="main-btn btn-clear" onclick="clearAll()">æ¸…ç©ºåˆ—è¡¨</button>
        <button class="main-btn btn-exec" id="execBtn" onclick="runBatchRename()" disabled>ç¡®è®¤æ‰¹é‡ä¿®æ”¹</button>
    </div>
    
    <div id="log">å‡†å¤‡å°±ç»ª</div>
</div>

<script>
    let filesData = [];

    window.onload = () => {
        const savedTitle = localStorage.getItem('lastSeriesTitle');
        if (savedTitle) document.getElementById('globalTitle').value = savedTitle;
    };

    function saveAndRefresh() {
        const title = document.getElementById('globalTitle').value;
        localStorage.setItem('lastSeriesTitle', title);
        refreshAllNames();
    }

    // --- æ ¸å¿ƒä¿®æ­£é€»è¾‘ï¼šå½»åº•è§£å†³æ—¶é—´æˆ³å¹²æ‰° ---
    function getSmartName(oldName) {
        const prefixInput = document.getElementById('globalTitle').value.trim();
        
        // 1. ç¬¬ä¸€æ­¥ï¼šå…ˆæŠŠæ–‡ä»¶åé‡Œçš„æ—¶é—´æˆ³å’Œå¹²æ‰°é¡¹é€šé€šåˆ‡æ‰
        // å‰”é™¤ï¼š8ä½ä»¥ä¸Šè¿ç»­æ•°å­— (å¦‚20260206)ã€å¸¦ä¸‹åˆ’çº¿çš„é•¿æ•°å­—ã€ä»¥åŠ final_video ç­‰å­—æ ·
        let cleanName = oldName
            .replace(/\d{8}(_\d{6})?/, '')     // å‰”é™¤ 20260206 æˆ– 20260206_082149
            .replace(/_final_video/gi, '')     // å‰”é™¤ final_video
            .replace(/\.mp4|\.mov|\.mkv/gi, '') // æš‚æ—¶å»æ‰åç¼€æ–¹ä¾¿åŒ¹é…
            .trim();

        // 2. æ¨¡å¼ Aï¼šåŒ¹é…â€œå‰§å-ç¬¬Xé›† æè¿°â€
        const regexA = /^(.*?)-ç¬¬([\dä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)é›†\s+(.*)/;
        const matchA = cleanName.match(regexA);
        if (matchA) {
            return `${prefixInput || matchA[1]} ç¬¬${matchA[2]}é›† ${matchA[3].trim()}.mp4`;
        }

        // 3. æ¨¡å¼ Bï¼šå¯»æ‰¾é›†æ•° (é™åˆ¶åœ¨1-4ä½ï¼Œé˜²æ­¢è¯¯æ€å…¶ä»–é•¿æ•°å­—)
        const regexB = /ç¬¬([\dä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]{1,4})[é›†è¯]/;
        const matchB = cleanName.match(regexB);
        if (matchB) {
            const num = matchB[1];
            const namePart = cleanName.split(regexB)[0].replace(/[-_]$/, '').trim();
            return `${prefixInput || namePart || 'ç´ æ'} ç¬¬${num}é›†.mp4`;
        }

        // 4. æ¨¡å¼ Cï¼šå¯»æ‰¾å‰©ä¸‹çš„çº¯æ•°å­—
        const matchC = cleanName.match(/(\d{1,4})/);
        if (matchC) {
            const num = matchC[1].replace(/^0+/, '') || "0";
            return `${prefixInput || 'ç´ æ'} ç¬¬${num}é›†.mp4`;
        }

        return `${prefixInput || 'ç´ æ'}_${cleanName}.mp4`;
    }

    async function addToFileList(handle) {
        if (handle.kind !== 'file' || !/\.(mp4|mov|mkv|webm|avi)$/i.test(handle.name)) return;
        if (filesData.some(f => f.oldName === handle.name)) return;
        filesData.push({
            handle: handle,
            oldName: handle.name,
            newName: getSmartName(handle.name),
            isDone: false
        });
    }

    function renderUI() {
        const tbody = document.getElementById('fileList');
        tbody.innerHTML = filesData.map((item, index) => {
            if (item.isDone) return `<tr><td colspan="2" class="status-done">âœ… å·²å®Œæˆï¼š${item.newName}</td><td style="text-align:center"><button class="op-btn del-btn" onclick="removeFile(${index})">ç§»é™¤è®°å½•</button></td></tr>`;
            return `<tr><td style="color: #666; font-size: 11px;">${item.oldName}</td><td><input type="text" class="edit-input" value="${item.newName}" oninput="updateManualName(${index}, this.value)"></td><td style="text-align: center;"><button class="op-btn modify-btn" onclick="renameSingle(${index})">ä¿®æ”¹</button><button class="op-btn del-btn" onclick="removeFile(${index})">ç§»é™¤</button></td></tr>`;
        }).join('');
        document.getElementById('execBtn').disabled = !filesData.some(f => !f.isDone);
        document.getElementById('log').innerText = `åŠ è½½æˆåŠŸï¼Œå‡†å¤‡å¤„ç† ${filesData.length} ä¸ªæ–‡ä»¶`;
    }

    async function renameSingle(index) {
        const item = filesData[index];
        try {
            if (await item.handle.queryPermission({mode: 'readwrite'}) !== 'granted') await item.handle.requestPermission({mode: 'readwrite'});
            await item.handle.move(item.newName);
            item.isDone = true;
            renderUI();
        } catch (err) { alert("ä¿®æ”¹å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¢«å ç”¨ã€‚"); }
    }

    async function runBatchRename() {
        const btn = document.getElementById('execBtn');
        btn.innerText = "å¤„ç†ä¸­...";
        btn.disabled = true;
        for (let item of filesData) {
            if (item.isDone) continue;
            try {
                if (await item.handle.queryPermission({mode: 'readwrite'}) !== 'granted') await item.handle.requestPermission({mode: 'readwrite'});
                await item.handle.move(item.newName);
                item.isDone = true;
            } catch (e) {}
        }
        renderUI();
        btn.innerText = "ç¡®è®¤æ‰¹é‡ä¿®æ”¹";
        alert("å…¨éƒ¨é‡å‘½åå®Œæˆï¼");
    }

    function updateManualName(index, val) { filesData[index].newName = val; }
    function removeFile(index) { filesData.splice(index, 1); renderUI(); }
    function clearAll() { filesData = []; renderUI(); }
    function refreshAllNames() {
        filesData.forEach(item => { if(!item.isDone) item.newName = getSmartName(item.oldName); });
        renderUI();
    }

    const dropZone = document.getElementById('dropZone');
    dropZone.ondragover = e => e.preventDefault();
    dropZone.ondrop = async e => {
        e.preventDefault();
        const items = [...e.dataTransfer.items];
        for (const item of items) {
            const h = await item.getAsFileSystemHandle();
            if (h.kind === 'directory') { for await (const entry of h.values()) await addToFileList(entry); }
            else await addToFileList(h);
        }
        renderUI();
    };

    async function selectFolder() {
        try {
            const d = await window.showDirectoryPicker();
            for await (const e of d.values()) await addToFileList(e);
            renderUI();
        } catch(e) {}
    }
</script>

</body>
</html>
